# MIT6.824_2021_lab4B_Sharded_Key/Value_Server

æœ€åï¼Œæ„å»ºä¸€ä¸ªåˆ†ç‰‡çš„ kv å®¹é”™ç³»ç»Ÿï¼›æ„Ÿè§‰æ¯” lab2 æ›´éš¾ç†è§£ï¼Œå› ä¸º lab2 æœ‰ä¸€ä¸ªæ¨¡æ¿è®ºæ–‡å¯ä»¥å‚è€ƒï¼Œä½†æ˜¯ lab4b åŸºæœ¬æ²¡æœ‰ä¸€ä¸ªå›ºå®šçš„èŒƒå¼

## Part B: Sharded Key/Value Server

æ¯ä¸ª shardkv server ç›¸å½“äºå‰¯æœ¬ç»„çš„ä¸€éƒ¨åˆ†ï¼Œæ¯ä¸ªå‰¯æœ¬ç»„ç›¸å½“äº lab3ï¼Œéƒ½æ”¯æŒ`Get, Put, Append`æ“ä½œï¼Œå½“ç„¶å®ƒä»¬å„è‡ªä»…ç»´æŠ¤å„è‡ªçš„åˆ†ç‰‡ï¼›

å®¢æˆ·ç«¯ä½¿ç”¨`key2shard()`å»æ‰¾åˆ°ä¸€ä¸ª key å¯¹åº”å“ªä¸ªåˆ†ç‰‡ï¼›

shardctrler æœåŠ¡å•ä¾‹å°†åˆ†ç‰‡åˆ†é…ç»™å‰¯æœ¬ç»„ï¼›å½“è¿™ä¸ªåˆ†ç‰‡åˆ†é…å‘ç”Ÿå˜åŒ–æ—¶ï¼Œraft å‰¯æœ¬ç»„ä¹‹é—´å¿…é¡»äº’ç›¸äº¤æ¢åˆ†ç‰‡ï¼ŒåŒæ—¶ç¡®ä¿å®¢æˆ·ç«¯ä¸ä¼šçœ‹åˆ°ä¸ä¸€è‡´çš„å“åº”ã€‚

multi-raft group ä½œä¸ºä¸€ä¸ªå®Œæ•´çš„å­˜å‚¨ç³»ç»Ÿï¼Œéœ€è¦å¯¹å¤–çº¿æ€§ä¸€è‡´æ€§ï¼Œè€ƒè™‘å½“å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚å’Œé…ç½®æ›´æ”¹åŒæ—¶å‘ç”Ÿæ—¶ï¼Œè¯·æ±‚éœ€è¦æ— æ„ŸçŸ¥å“åº”

### å®¹é”™

ä»å¤§åˆ°å°çš„ç²’åº¦æœ‰ï¼šæ•´ä¸ª kv ç³»ç»Ÿ + ä¸€ä¸ª raft åˆ†ç‰‡æ§åˆ¶å™¨ç»„ > å¤šä¸ª raft åˆ†ç‰‡å‰¯æœ¬ç»„ > ä¸€ä¸ª raft å‰¯æœ¬ç»„å†…çš„å„ä¸ª server èŠ‚ç‚¹

å½“ä¸€ä¸ª raft ç»„å†…çš„å¤§å¤šæ•°èƒ½æ­£å¸¸é€šä¿¡ï¼Œè¯¥ raft ç»„å¯ä»¥æ­£å¸¸å·¥ä½œï¼›å½“è‡³å°‘ä¸€ä¸ª raft ç»„èƒ½å’Œ åˆ†ç‰‡æ§åˆ¶å™¨ç»„å•ä¾‹é€šä¿¡æ—¶ï¼Œè¯¥åˆ†ç‰‡ç³»ç»Ÿæ‰èƒ½æ­£å¸¸å·¥ä½œ

å®ç°å¿…é¡»èƒ½æ­£å¸¸è¿è¡Œ(ä¸ºè¯·æ±‚æä¾›æœåŠ¡ï¼Œå¹¶èƒ½å¤Ÿæ ¹æ®éœ€è¦é‡æ–°é…ç½®)ï¼Œå³ä½¿æŸäº›å‰¯æœ¬ç»„ä¸­çš„å°‘æ•°æœåŠ¡å™¨æ­»æœºã€æš‚æ—¶ä¸å¯ç”¨æˆ–è¿è¡Œç¼“æ…¢ï¼ˆé«˜åˆ†åŒºå®¹é”™æ€§ï¼‰

### å…³äºraft ç»„å†…çš„æˆå‘˜å˜æ›´

ä¸€ä¸ªshardkvæœåŠ¡å™¨ä»…ä»…æ˜¯ä¸€ä¸ªå‰¯æœ¬ç»„çš„æˆå‘˜ï¼Œç»™å®šå‰¯æœ¬ç»„ä¸­çš„æœåŠ¡å™¨é›†æ°¸è¿œä¸ä¼šæ›´æ”¹ã€‚

å³ä¸éœ€è¦å®ç° raft ç»„æˆå‘˜å˜æ›´

### å…³äºå®¢æˆ·ç«¯

Clerk å°†æ¯ä¸ªRPCå‘é€åˆ°è´Ÿè´£RPCé”®çš„å‰¯æœ¬ç»„ï¼›ä½†å¦‚æœè¯¥ key å¹¶ä¸åœ¨å‰¯æœ¬ç»„è´Ÿè´£çš„åˆ†ç‰‡ä¸­ï¼Œå‰¯æœ¬ç»„ä¼šæç¤º Clerk é‡å®šå‘ï¼›åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯éœ€è¦å‘åˆ†ç‰‡æ§åˆ¶å™¨è¯¢é—®æœ€æ–°çš„é…ç½®å¹¶é‡è¯•ã€‚å‚è€ƒ kvraftï¼Œè¿›è¡Œä¿®æ”¹ï¼›

### å®éªŒè¦æ±‚

é¦–è¦ä»»åŠ¡æ˜¯é€šè¿‡ç¬¬ä¸€ä¸ª shardkv æµ‹è¯•ï¼›æœ€å¤§çš„æ”¹å˜æ˜¯éœ€è¦è®©æœåŠ¡å™¨çŸ¥é“é…ç½®å‘ç”Ÿäº†æ›´æ”¹å¹¶å¼€å§‹æ¥å—æ–°é…ç½®åˆ†ç‰‡æ‰€å±çš„è¯·æ±‚ï¼›

#### é…ç½®å˜æ›´

é€šè¿‡ç¬¬ä¸€ä¸ªæµ‹è¯•ä¹‹åï¼Œéœ€è¦å¤„ç†é…ç½®å˜æ›´ï¼›

éœ€è¦è®©æœåŠ¡å™¨ç›‘å¬é…ç½®å˜æ›´ï¼Œä¸€æ—¦é…ç½®å‘ç”Ÿå˜æ›´ï¼Œéœ€è¦å¼€å§‹åˆ†ç‰‡è¿ç§»è¿‡ç¨‹ï¼›

- è‹¥ä¸€ä¸ªå‰¯æœ¬ç»„å¸è½½äº†ä¸€ä¸ªåˆ†ç‰‡ï¼Œå…¶å¿…é¡»ç«‹å³åœæ­¢æœåŠ¡è¯¥åˆ†ç‰‡çš„è¯·æ±‚ï¼Œå¹¶å¼€å§‹è¿ç§»åˆ†ç‰‡æ•°æ®åˆ°æ–°æ¥ç®¡çš„å‰¯æœ¬ç»„

- è‹¥ä¸€ä¸ªå‰¯æœ¬ç»„è£…è½½äº†ä¸€ä¸ªåˆ†ç‰‡ï¼Œå…¶éœ€è¦ç­‰è¯¥åˆ†ç‰‡çš„å‰ä»»å‘é€å®Œåˆ†ç‰‡æ•°æ®åå¼€å§‹æ¥æ”¶è¯¥åˆ†ç‰‡çš„è¯·æ±‚

ç¡®ä¿å‰¯æœ¬ç»„å†…çš„æ‰€æœ‰æœåŠ¡å™¨åœ¨åŒä¸€çº¿æ€§é¡ºåºä¸‹å®Œæˆåˆ†ç‰‡è¿ç§»ï¼Œä»¥è‡³äºæœåŠ¡å™¨å¯ä»¥åŒæ—¶æ¥å—æˆ–æ‹’ç»å®¢æˆ·ç«¯è¯·æ±‚ï¼›

åœ¨å¤„ç†åé¢çš„æµ‹è¯•ä¹‹å‰ï¼Œæ‚¨åº”è¯¥é›†ä¸­ç²¾åŠ›é€šè¿‡ç¬¬äºŒä¸ªæµ‹è¯•`join then leave`ã€‚å½“æ‚¨é€šè¿‡åˆ°`TestDelete`(ä¸åŒ…æ‹¬TestDelete)çš„æ‰€æœ‰æµ‹è¯•æ—¶ï¼Œå°±å®Œæˆäº†æ­¤ä»»åŠ¡ã€‚

### å®éªŒæç¤º

- æœåŠ¡å™¨ä¸éœ€è¦è°ƒç”¨åˆ†ç‰‡æ§åˆ¶å™¨çš„`Join()`ï¼Œtester æ‰ä¼šå»è°ƒç”¨ï¼›
- æœåŠ¡å™¨å°†éœ€è¦å®šæœŸè½®è¯¢ shardctrler ä»¥ç›‘å¬æ–°çš„é…ç½®ã€‚é¢„æœŸå¤§çº¦æ¯100æ¯«ç§’è½®è¯¢ä¸€æ¬¡ï¼›å¯ä»¥æ›´é¢‘ç¹ï¼Œä½†è¿‡å°‘å¯èƒ½ä¼šå¯¼è‡´ bugã€‚

- æœåŠ¡å™¨éœ€è¦äº’ç›¸å‘é€rpcï¼Œä»¥ä¾¿åœ¨é…ç½®æ›´æ”¹æœŸé—´ä¼ è¾“åˆ†ç‰‡ã€‚shardctrlerçš„Configç»“æ„åŒ…å«æœåŠ¡å™¨åï¼Œä¸€ä¸ª Server éœ€è¦ä¸€ä¸ª`labrpc.ClientEndï¼Œ`ä»¥ä¾¿å‘é€RPCã€‚ä½¿ç”¨`make_end()`å‡½æ•°ä¼ ç»™`StartServer()`å‡½æ•°å°†æœåŠ¡å™¨åè½¬æ¢ä¸ºClientEndã€‚`shardkv /client.go`éœ€è¦å®ç°è¿™äº›é€»è¾‘ã€‚
- åœ¨`server.go`ä¸­æ·»åŠ ä»£ç å»å‘¨æœŸæ€§ä» shardctrler æ‹‰å–æœ€æ–°çš„é…ç½®ï¼Œå¹¶ä¸”å½“è¯·æ±‚åˆ†ç‰‡ä¸å±äºè‡ªèº«æ—¶ï¼Œæ‹’ç»è¯·æ±‚
- å½“è¢«è¯·æ±‚åˆ°é”™è¯¯åˆ†ç‰‡æ—¶ï¼Œéœ€è¦è¿”å›`ErrWrongGroup`ç»™å®¢æˆ·ç«¯ï¼Œå¹¶ç¡®ä¿`Get, Put, Append`åœ¨é¢ä¸´å¹¶å‘é‡é…ç½®æ—¶èƒ½æ­£ç¡®ä½œå‡ºå†³å®š
- é‡é…ç½®éœ€è¦æŒ‰æµç¨‹æ‰§è¡Œå”¯ä¸€ä¸€æ¬¡
- labgob çš„æç¤ºé”™è¯¯ä¸èƒ½å¿½è§†ï¼Œå®ƒå¯èƒ½å¯¼è‡´å®éªŒä¸è¿‡
- åˆ†ç‰‡é‡åˆ†é…çš„è¯·æ±‚ä¹Ÿéœ€è¦åšé‡å¤è¯·æ±‚æ£€æµ‹
- è‹¥å®¢æˆ·ç«¯æ”¶åˆ°`ErrWrongGroup`ï¼Œæ˜¯å¦æ›´æ”¹è¯·æ±‚åºåˆ—å·ï¼Ÿè‹¥æœåŠ¡å™¨æ‰§è¡Œè¯·æ±‚æ—¶è¿”å›`ErrWrongGroup`ï¼Œæ˜¯å¦æ›´æ–°å®¢æˆ·ç«¯ä¿¡æ¯ï¼Ÿ
- å½“æœåŠ¡å™¨è½¬ç§»åˆ°æ–°é…ç½®åï¼Œå®ƒå¯ä»¥ç»§ç»­å­˜å‚¨å®ƒä¸å†è´Ÿè´£çš„åˆ†ç‰‡ï¼ˆç”Ÿäº§ç¯å¢ƒä¸­è¿™æ˜¯ä¸å…è®¸çš„ï¼‰ï¼Œä½†è¿™ä¸ªå¯ä»¥ç®€åŒ–å®ç°
- å½“ G1 åœ¨é…ç½®å˜æ›´æ—¶éœ€è¦æ¥è‡ª G2 çš„åˆ†ç‰‡æ•°æ®ï¼ŒG2 å¤„ç†æ—¥å¿—æ¡ç›®çš„å“ªä¸ªæ—¶é—´ç‚¹å°†åˆ†ç‰‡å‘é€ç»™ G1 æ˜¯æœ€å¥½çš„ï¼Ÿ
- ä½ å¯ä»¥åœ¨æ•´ä¸ª rpc è¯·æ±‚æˆ–å›å¤ä¸­å‘é€æ•´ä¸ª mapï¼Œè¿™å¯ä»¥ç®€åŒ–åˆ†ç‰‡ä¼ è¾“
- map æ˜¯å¼•ç”¨ç±»å‹ï¼Œæ‰€ä»¥åœ¨å‘é€ map çš„æ—¶å€™ï¼Œå»ºè®®å…ˆæ‹·è´ä¸€æ¬¡ï¼Œé¿å… data raceï¼ˆåœ¨ labrpc æ¡†æ¶ä¸‹ï¼Œæ¥æ”¶ map æ—¶ä¹Ÿéœ€è¦æ‹·è´ï¼‰
- åœ¨é…ç½®æ›´æ”¹æœŸé—´ï¼Œä¸€å¯¹ç»„å¯èƒ½éœ€è¦äº’ç›¸ä¼ é€åˆ†ç‰‡ï¼Œè¿™å¯èƒ½ä¼šå‘ç”Ÿæ­»é”

## challenge

å¦‚æœæƒ³è¾¾åˆ°ç”Ÿäº§ç¯å¢ƒç³»ç»Ÿçº§åˆ«ï¼Œå¦‚ä¸‹ä¸¤ä¸ªæŒ‘æˆ˜æ˜¯éœ€è¦å®ç°çš„

### challenge1ï¼šGarbage collection of state

å½“ä¸€ä¸ªå‰¯æœ¬ç»„å¤±å»ä¸€ä¸ªåˆ†ç‰‡çš„æ‰€æœ‰æƒæ—¶ï¼Œå‰¯æœ¬ç»„éœ€è¦åˆ é™¤è¯¥åˆ†ç‰‡æ•°æ®ã€‚ä½†è¿™ç»™è¿ç§»å¸¦æ¥ä¸€äº›é—®é¢˜ï¼Œè€ƒè™‘ä¸¤ä¸ªç»„G1 å’Œ G2ï¼Œå¹¶ä¸”æ–°é…ç½®C å°†åˆ†ç‰‡ä» G1 ç§»åŠ¨åˆ° G2ï¼Œè‹¥ G1 åœ¨è½¬æ¢é…ç½®åˆ°Cæ—¶åˆ é™¤äº†æ•°æ®åº“ä¸­çš„åˆ†ç‰‡ï¼Œå½“G2 è½¬æ¢åˆ°Cæ—¶ï¼Œå¦‚ä½•è·å– G1 çš„æ•°æ®

### å®éªŒè¦æ±‚

ä½¿æ¯ä¸ªå‰¯æœ¬ç»„ä¿ç•™æ—§åˆ†ç‰‡çš„æ—¶é•¿ä¸å†æ˜¯æ— é™æ—¶é•¿ï¼Œå³ä½¿å‰¯æœ¬ç»„(å¦‚ä¸Šé¢çš„G1)ä¸­çš„æ‰€æœ‰æœåŠ¡å™¨å´©æºƒå¹¶æ¢å¤æ­£å¸¸ï¼Œè§£å†³æ–¹æ¡ˆä¹Ÿå¿…é¡»å·¥ä½œã€‚å¦‚æœæ‚¨é€šè¿‡`TestChallenge1Delete`ï¼Œæ‚¨å°±å®Œæˆäº†è¿™ä¸ªæŒ‘æˆ˜ã€‚

### è§£å†³æ–¹æ¡ˆ

åœ¨åˆ†ç‰‡è¿ç§»æˆåŠŸä¹‹åï¼Œå¯ä»¥ç«‹é©¬è¿›è¡Œåˆ†ç‰‡ GC äº†ï¼ŒGC å®Œæ¯•åå†è¿›å…¥åˆ°é…ç½®æ›´æ–°é˜¶æ®µ

### chanllenge2ï¼šClient requests during configuration changes

é…ç½®æ›´æ”¹æœŸé—´æœ€ç®€å•çš„æ–¹å¼æ˜¯ç¦æ­¢æ‰€æœ‰å®¢æˆ·ç«¯æ“ä½œç›´åˆ°è½¬æ¢å®Œæˆï¼Œè™½ç„¶ç®€å•ä½†æ˜¯ä¸æ»¡è¶³äºç”Ÿäº§ç¯å¢ƒè¦æ±‚ï¼Œè¿™å°†å¯¼è‡´å®¢æˆ·ç«¯é•¿æ—¶é—´åœæ»ï¼Œæœ€å¥½å¯ä»¥ç»§ç»­ä¸ºä¸å—å½“å‰é…ç½®æ›´æ”¹çš„åˆ†ç‰‡æä¾›æœåŠ¡

ä¸Šè¿°ä¼˜åŒ–è¿˜èƒ½æ›´å¥½ï¼Œè‹¥ G3 åœ¨è¿‡æ¸¡åˆ°é…ç½®Cæ—¶ï¼Œéœ€è¦æ¥è‡ªG1 çš„åˆ†ç‰‡S1 å’Œ G2 çš„åˆ†ç‰‡S2ã€‚å¸Œæœ› G3 èƒ½åœ¨æ”¶åˆ°å…¶ä¸­ä¸€ä¸ªåˆ†ç‰‡åå¯ä»¥ç«‹å³å¼€å§‹æ¥æ”¶é’ˆå¯¹è¯¥åˆ†ç‰‡çš„è¯·æ±‚ã€‚å¦‚G1å®•æœºäº†ï¼ŒG3åœ¨æ”¶åˆ°G2çš„åˆ†ç‰‡æ•°æ®åï¼Œå¯ä»¥ç«‹å³ä¸º S2 åˆ†ç‰‡æä¾›æœåŠ¡ï¼Œè€Œä¸éœ€è¦ç­‰å¾… C é…ç½®è½¬æ¢å®Œå…¨å®Œæˆ

### å®éªŒè¦æ±‚

ä¿®æ”¹æ‚¨çš„è§£å†³æ–¹æ¡ˆï¼Œä»¥ä¾¿åœ¨é…ç½®æ›´æ”¹æœŸé—´ç»§ç»­æ‰§è¡Œä¸å—å½±å“çš„åˆ†ç‰‡ä¸­çš„ key çš„å®¢æˆ·ç«¯æ“ä½œã€‚å½“æ‚¨é€šè¿‡ `TestChallenge2Unaffected` æµ‹è¯•æ—¶ï¼Œæ‚¨å·²ç»å®Œæˆäº†è¿™ä¸ªæŒ‘æˆ˜ã€‚

ä¿®æ”¹æ‚¨çš„è§£å†³æ–¹æ¡ˆï¼Œåœ¨é…ç½®è½¬æ¢è¿›è¡Œä¸­ï¼Œå‰¯æœ¬ç»„ä¹Ÿå¯ä»¥ç«‹å³å¼€å§‹æä¾›åˆ†ç‰‡æœåŠ¡ã€‚å½“æ‚¨é€šè¿‡`TestChallenge2Partial`æµ‹è¯•æ—¶ï¼Œæ‚¨å·²ç»å®Œæˆäº†è¿™ä¸ªæŒ‘æˆ˜ã€‚

### è§£å†³æ–¹æ¡ˆ

åˆ†ç‰‡è¿ç§»åº”è¯¥æ˜¯ä»¥ gid ä¸ºå•ä½ï¼Œå³ `gid -> []shard`ï¼Œè¿™æ ·å³ä½¿ä¸€ä¸ª gid æŒ‚äº†ï¼Œä¹Ÿä¸ä¼šå½±å“åˆ°å¦ä¸€ä¸ª gid ä¸­çš„åˆ†ç‰‡

----

> ä»¥ä¸Šæ€»ç»“è‡ªå®éªŒå®˜ç½‘ï¼šhttps://pdos.csail.mit.edu/6.824/labs/lab-shard.html
>
> ä¸çŸ¥é“ä»€ä¹ˆæƒ…å†µï¼Œåœ¨ 2021 çš„ schedule é‡Œç‚¹è¿› lab4 ï¼Œè¿˜æ˜¯ 2020 çš„

## å®éªŒæ€è·¯

ä¸€å¼€å§‹çœŸçš„æ— ä»ä¸‹æ‰‹ï¼Œä¿¡æ¯é‡å¤ªå¤§ï¼Œçœ‹åˆ«äººçš„åšå®¢æ–‡ç« ç”šè‡³éƒ½ä¸çŸ¥é“é—®é¢˜æœ¬èº«åœ¨æè¿°ä»€ä¹ˆï¼›

> åœ¨å‚è€ƒäº† https://github.com/LebronAl/MIT6.824-2021/blob/master/docs/lab4.md çš„è®¨è®ºåï¼Œæœ‰äº†äº›è®¸çœ‰ç›®

æ¦‚æ‹¬æ¥è¯´ï¼Œlab4B éœ€è¦ä½ å®ç°ä¸€ä¸ª åŸºäº multi-raft çš„åˆ†ç‰‡åˆ†å¸ƒå¼ key-value ç³»ç»Ÿï¼Œä¸»è¦åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†`shardctrler`é…ç½®ç®¡ç†å™¨ï¼Œä»¥åŠ`shardkv`åˆ†ç‰‡key-value ç³»ç»Ÿï¼Œæ¶æ„å›¾å¦‚ä¸‹

![Snipaste_2021-12-20_21-30-29](./img/Snipaste_2021-12-20_21-30-29.png)

å¹¶ä¸”åœ¨è¡Œä¸ºä¸Šï¼š

- å®¢æˆ·ç«¯å¯ä»¥å’Œ`shardctrler`äº¤äº’ï¼Œæ‹¿åˆ°æœ€æ–°çš„é…ç½®ï¼Œç„¶åç”¨è¯¥é…ç½®æ‰¾åˆ°å¯¹åº” key çš„ shardï¼Œæœ€ç»ˆè¯·æ±‚æœåŠ¡è¯¥ shard çš„ group
- æœåŠ¡ç«¯ä¹Ÿéœ€è¦å®šæœŸå’Œ`shardctrler`äº¤äº’ï¼Œä¿è¯æ›´æ–°åˆ°æœ€æ–°é…ç½®(monitor)
- æ£˜æ‰‹çš„éƒ¨åˆ†æ˜¯ï¼šæµ‹è¯•ä»£ç ä¼šå¶å°”æ‰§è¡Œ`Join`ï¼Œ`Leave`ç­‰ï¼Œè®©æŸäº› group åœ¨ç³»ç»Ÿä¸­è„±ç¦»ï¼Œç„¶åå„ä¸ª group ä¹‹é—´èƒ½ä¾ç…§æœ€æ–°é…ç½®(lab4A)ï¼Œåšåˆ†ç‰‡çš„è¿ç§»å’Œåˆ†ç‰‡çš„GC

å¦‚æœæ²¡æœ‰ç¬¬ä¸‰éƒ¨åˆ†ï¼Œå…¶å®å‰ä¸¤éƒ¨åˆ†å¾ˆå¥½å®ç°

### Clerk

æƒ³ä¸€åˆ‡ä»ç®€ï¼Œå…ˆå°è¯•ä» Clerk æ”¹é€ å…¥æ‰‹ï¼Œå’Œ lab4A å¼•å…¥çš„æ¦‚å¿µä¸€æ ·ï¼Œåœ¨ multi-raft çš„æ¡†æ¶ä¸‹ï¼Œå˜æˆäº†ä¸€ä¸ª group ä¸‹åŒ…å«å¤šä¸ª serversï¼šgroup_id(gid) -> server_idï¼Œå¹¶ä¸”ä¸€ä¸ª group å¯èƒ½è´Ÿè´£å¤šä¸ª shardï¼›åˆ™ Clerk çš„è¯·æ±‚é€»è¾‘ä¸ºï¼š

1. æ ¹æ®`shard`ä»å½“å‰é…ç½®ä¸­æ‹¿åˆ°æœ‰æ•ˆçš„ gidï¼š`gid := config.Shards[shard]`
2. ç»§ç»­ä»é…ç½®ä¸­æ‹¿åˆ°æœ‰æ•ˆçš„ group ä¿¡æ¯ï¼š`group := config.Groups[gid]`
3. å¾ªç¯ï¼šåœ¨ä¸€ä¸ª group ä¸­é‡å¤å¯»æ‰¾ leaderï¼Œç›´åˆ°è¯·æ±‚æˆåŠŸ
4. è‹¥`ErrWrongGroup`æˆ–æ•´ä¸ª group éƒ½éå†è¯·æ±‚è¿‡äº†ï¼Œåˆ™è·³å‡º 3. çš„å¾ªç¯
5. `Query` æœ€æ–°çš„é…ç½®ï¼Œå›åˆ° 1. é‡å¤

```go
for {
  shard := key2shard(key)
  if gid := ck.config.Shards[shard]; gid != 0 {
		leaderId := ck.gid2LeaderIdMap[gid]
		oldLeaderId := leaderId
    if group, ok := ck.config.Groups[gid]; ok {
      for {
        var reply Reply
        serverName := group[leaderId]
        ok := ck.sendGet(serverName, &args, &reply) // makeEnd & Call
        if ok && (reply.Err == OK || reply.Err == ErrNoKey) {
          ck.gid2LeaderIdMap[gid] = leaderId
          return
        }
        if ok && reply.Err == ErrWrongGroup {
          break
        }
        leaderId = (leaderId + 1) % len(group)
        if leaderId == oldLeaderId {
          break
        }
      }
    }
  }
  time.Sleep(clientRetryPeriod)
  ck.config = ck.sm.Query(-1)
}
```

### server

lab4B å¯ä»¥ç†è§£ä¸ºå°† lab3B çš„ kvraft å’Œ lab4A çš„ shardctrler ç»“åˆèµ·æ¥ï¼Œå¹¶ä¸”éœ€è¦å°† lab3B çš„ kvraft æ”¹é€ ä¸ºåˆ†ç‰‡çš„ï¼Œå³åŸæ¥çš„ kvMap ä¸å†æ˜¯æ•´ä¸ªæ•°æ®å¡è¿›æ¥äº†ï¼Œè€Œæ˜¯å˜æˆäº†ç±»ä¼¼äº`[Nshards]map[string]string`çš„ç»“æ„ï¼›

é™¤æ­¤ä¹‹å¤–ï¼Œåˆ†ç‰‡å¹¶ä¸æ˜¯åœ¨ä¸€ä¸ª group ä¸­æ’å®šçš„ï¼Œå®ƒä»¬ä¼šæ ¹æ®é…ç½®åšåŠ¨æ€è¿ç§»ï¼Œåˆ™éœ€è¦åˆ¶å®šä¸€ä¸ª group ä¹‹é—´çš„åˆ†ç‰‡è¿ç§»æ–¹æ¡ˆï¼Œè¿™ä¸ªä¹Ÿæ˜¯è¾ƒä¸ºæ£˜æ‰‹çš„ä¸€éƒ¨åˆ†ï¼›

å¦å¤–ï¼Œåœ¨ challenge ä¸­ï¼Œåˆ†ç‰‡è¿˜éœ€è¦ä¼šè¢«å®šæœŸ GC

å…ˆè¯´ç»“è®ºï¼Œæˆ‘å°†æ•´ä¸ª lab4B çš„ server æŠ½è±¡å‡ºäº†å‡ ä¸ªéƒ¨åˆ†ï¼ˆæ–‡ä»¶ï¼‰ï¼š`shard`ï¼Œ`op`ï¼Œ`applier`ï¼Œ`monitor`ï¼Œ`snapshot`

#### shard

åˆ™å¯ä»¥é¦–å…ˆå®šä¹‰åº•å±‚çš„åˆ†ç‰‡æ•°æ®ç»“æ„`shardData`ï¼Œå¹¶å°è£…å‡ºå¯¹åº”çš„æ¯ä¸ªåˆ†ç‰‡çš„æ–¹æ³•ï¼Œå¦‚ getter setter ç­‰

```go
// ShardData æ¯ä¸ªåˆ†ç‰‡ç›¸å…³çš„æ•°æ®ï¼Œç”¨äº æ•°æ®è¯»å–ï¼Œè¯·æ±‚å»é‡ï¼ŒçŠ¶æ€æ£€æµ‹
type ShardData struct {
	Status                shardStatus       // åˆ†ç‰‡çŠ¶æ€
	Data                  map[string]string // k-v å­˜å‚¨
	ClientId2RequestIdMap map[int64]int64   // é‡å¤è¯·æ±‚æ£€æµ‹
}


type shardStatus int

// åˆ†ç‰‡çŠ¶æ€
const (
	shardNormal  shardStatus = iota + 1 // çŠ¶æ€æ­£å¸¸ï¼ŒåŒ…æ‹¬ä¸è´Ÿè´£çš„åˆ†ç‰‡
	shardPushing                        // æ­£åœ¨å‘å…¶ä»– group æ¨é€ shard
	shardPulling                        // æ­£åœ¨ç­‰å¾…å…¶ä»– group æ¨é€ shard ç»™æˆ‘
)
```

åˆ†ç‰‡çŠ¶æ€ä¸º åˆ†ç‰‡è¿ç§» å’Œ åˆ†ç‰‡GC åšå‡†å¤‡

#### op

åœ¨ lab3 ä¸­ï¼ŒClerk çš„è¯·æ±‚ä¼šè¢«åŒ…è£…æˆä¸€ä¸ª Op ä¼ ç»™ raft å±‚ï¼Œåˆ™åœ¨ lab4 ä¸­ï¼Œä¸éš¾æƒ³åˆ°ï¼Œservers ä¹‹é—´çš„äº¤äº’ï¼Œä¹Ÿå¯ä»¥çœ‹åšæ˜¯åŒ…è£…æˆ Op ä¼ ç»™ raft å±‚ï¼›

å³ raft å±‚ä¾æ—§æ˜¯ä¿è¯æ•´ä¸ª group çš„çŠ¶æ€è½¬ç§»æ˜¯åŸºäºå‰¯æœ¬å®¹é”™çš„ï¼Œå¯è¿½æº¯å¹¶ä¸”çº¿æ€§ä¸€è‡´æ€§ï¼›å³æŠ½è±¡æ¥çœ‹ï¼Œä¸€åˆ‡è®© group æœ¬èº«ä¿¡æ¯äº§ç”Ÿå˜åŒ–çš„æ“ä½œéƒ½å¯ä»¥åŒ…è£…æˆ Op äº¤ç»™ raft å±‚åŒæ­¥

é‚£ä¹ˆ group å¯èƒ½ä¼šæ‰§è¡Œçš„æ“ä½œåŒ…æ‹¬ï¼š

- å®¢æˆ·ç«¯è¯·æ±‚
- å’Œ`shardCtrler`äº¤äº’åšé…ç½®æ›´æ–°
- `groups`ä¹‹é—´çš„åˆ†ç‰‡è¿ç§»
- åˆ†ç‰‡GC

åˆ™å¯ä»¥å°è£…å‡ºå¯¹åº”çš„ Opï¼š

- ClientOpï¼ˆå…¶å®å°±æ˜¯ lab3 åŠ ä¸ª shardIdï¼‰
- ConfigOpï¼ˆè¿™é‡Œæˆ‘ç›´æ¥ç”¨ shardctrler.Config åš Opï¼‰
- ShardOpï¼ˆå¯¹åº”åˆ†ç‰‡è¿ç§»å’Œåˆ†é…GCï¼‰

```go
// ClientOp å®¢æˆ·ç«¯è¯·æ±‚æ“ä½œ
type ClientOp struct {
	// Your definitions here.
	// Field names must start with capital letters,
	// otherwise RPC will break.
	ShardId   int    // è®¿é—®çš„åˆ†ç‰‡ id
	Name      string // Get Put Append
	Key       string
	Value     string
	ClientId  int64
	RequestId int64
}


// Config A configuration -- an assignment of shards to groups.
// Please don't change this.
type Config struct {
	Num    int              // config number
	Shards [NShards]int     // shard -> gid
	Groups map[int][]string // gid -> servers[]
}


// ShardOp åˆ†ç‰‡è¿ç§»æ“ä½œ
type ShardOp struct {
	Type          shardOpType               // install æˆ– gc
	ConfigNum     int                       // å½“å‰é…ç½®ç‰ˆæœ¬
	ShardIds      []int                     // è®¿é—®çš„åˆ†ç‰‡ id
	Datas         map[int]map[string]string // åˆ†ç‰‡æ•°æ®
	RequestIdMaps map[int]map[int64]int64   // åˆ†ç‰‡å»é‡
}


type shardOpType int

// åˆ†ç‰‡æ“ä½œç±»å‹
const (
	shardInstallOp shardOpType = iota + 1 // è¢«åŠ¨æ–¹å®‰è£…åˆ†ç‰‡
	shardGCOp                             // ä¸»åŠ¨æ–¹ GC åˆ†ç‰‡
)
```

å…¶ä¸­ ShardOp è¿™æ ·çš„è®¾è®¡çš„åŸå› å’Œåˆ†é…è¿ç§»é€‰æ‹©çš„æ¨¡å¼æœ‰å…³ï¼Œä¸‹æ–‡ä¼šæœ‰è¯´æ˜

#### applier

å…¶å®æ ¹æ® lab3ï¼Œæˆ‘ä»¬å°±å·²ç»å¯ä»¥æŠ½ç¦»å‡ºä¸€ä¸ª`applier`ç»“æ„ï¼Œå…¶ä¸º server ä¸­ä¸€ä¸ª raft çš„`applyCh`çš„æ€»çº¿ï¼ŒåŸºæœ¬æ‰€æœ‰å†™æ“ä½œéƒ½åœ¨`applier`ä¸­å®ç°ï¼Œå¹¶ä¸”`applier`æœ‰ä¸¥æ ¼çš„é€»è¾‘é¡ºåºï¼Œæ ¹æ® Op çš„ç±»å‹çš„ä¸åŒï¼Œåˆå¯ä»¥åˆ†æµå‡ºä¸‰ç§å¤„ç†é€»è¾‘

```go
// applier
func (kv *ShardKV) applyEventLoop() {
	for msg := range kv.applyCh {
		switch true {
		case msg.CommandValid:
			kv.doCommand(msg)
		case msg.SnapshotValid:
			kv.doSnapshot(msg)
		default:
		}
	}
}


func (kv *ShardKV) doCommand(msg raft.ApplyMsg) {
	commandIndex := msg.CommandIndex
	if kv.enableSnapshot() {
		if commandIndex <= kv.snapshotIndex {
			return
		}
	}
	kv.mu.Lock()
	respErr := OK
	switch msg.Command.(type) {
  // å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
	case ClientOp:
		respErr = kv.applyClientOp(msg)
  // å¤„ç†é…ç½®æ“ä½œ
	case shardctrler.Config:
		kv.applyConfigOp(msg)
  // å¤„ç†åˆ†ç‰‡æ“ä½œ
	case ShardOp:
		kv.applyShardOp(msg)
	}
	// æ³¨æ„è¿™é‡Œæ— è®ºæ˜¯è¯·æ±‚æœ‰è¯¯ï¼Œæˆ–è€…ä¸æœåŠ¡è¯¥åˆ†ç‰‡ï¼Œéƒ½éœ€è¦å°†èµ„æºé‡Šæ”¾æ‰
	if doneChan, ok := kv.opDoneChanMap[commandIndex]; ok {
		doneChan <- respErr
		// close åšé€šçŸ¥
		close(doneChan)
		delete(kv.opDoneChanMap, commandIndex)
	}
	kv.mu.Unlock()
	if kv.enableSnapshot() {
		if kv.persister.RaftStateSize() >= kv.maxraftstate {
			kv.rf.Snapshot(commandIndex, kv.kvState())
			kv.snapshotIndex = commandIndex
		}
	}
}
```

é™¤æ­¤ä¹‹å¤–ï¼Œapplier è¿˜éœ€è¦å¯¹å„ç§Opåšå»é‡å’Œåˆæ³•æ“ä½œï¼Œåœ¨ lab3 ä¸­çš„è¡¨ç°å½¢å¼å°±æ˜¯`clientId, requestId`ï¼Œåœ¨ lab4 ä¸­æ›´æŠ½è±¡æ¥çœ‹ï¼Œä¸æ­¢å®¢æˆ·ç«¯è¯·æ±‚ï¼Œé…ç½®ç‰ˆæœ¬å·ä¹Ÿéœ€è¦è€ƒè™‘è¿›å»

#### monitor

å‚è€ƒåˆ«äººçš„åšå®¢ä¸­çš„è®¾è®¡ï¼Œä»¥åŠåŸlab ä¸­çš„æç¤ºï¼š

> Your server will need to periodically poll the shardctrler to learn about new configurations. The tests expect that your code polls roughly every 100 milliseconds; more often is OK, but much less often may cause problems.

å¯ä»¥æŠ½ç¦»å‡ºä¸€ä¸ª monitorï¼Œç”¨äºå®šæœŸè½®è¯¢`shardctrler`æ›´æ–°é…ç½® å’Œ å®šæœŸæ£€æµ‹åˆ†ç‰‡çŠ¶æ€å¹¶ä½œå‡ºå¯¹äºæ“ä½œï¼ˆè¿ç§»æˆ–GCï¼‰

è¿™é‡Œæˆ‘ç”¨åˆ°äº†ä¸¤ä¸ª monitor åç¨‹ï¼Œä¸€ä¸ªæ›´æ–°é…ç½®ï¼Œä¸€ä¸ªç›‘å¬åˆ†ç‰‡çŠ¶æ€å¹¶ä½œå‡ºè¿ç§»æ“ä½œï¼›æ³¨æ„ï¼Œæ›´æ–°é…ç½®åªæœ‰åœ¨æ‰€æœ‰åˆ†ç‰‡çŠ¶æ€éƒ½æ­£å¸¸çš„æƒ…å†µä¸‹æ‰ä¼šä¸»åŠ¨è¯·æ±‚`shardctrler`ï¼Œå¦åˆ™å°±å…ˆæ‰§è¡Œåˆ†ç‰‡çš„è¿ç§»æˆ–è€… GCï¼ŒåŸå› æ˜¯ï¼Œå½“æœ‰åˆ†ç‰‡çŠ¶æ€ä¸ä¸º normalï¼Œåˆ™è¯æ˜åœ¨å½“å‰ config ä¸‹ä»æœ‰åˆ†ç‰‡æœªè¿ç§»å®Œæ¯•æˆ–æœªGC å®Œæ¯•ï¼Œæ­¤æ—¶ä¸èƒ½è¿›å…¥ä¸‹ä¸€ä¸ª config

```go
// ç›‘è§†å™¨ï¼Œæ¯éš”ä¸€å®šæ—¶é—´ç”± leader è¿›è¡Œå®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œ
func (kv *ShardKV) monitor(do func(), timeout time.Duration) {
	for !kv.killed() {
		_, isLeader := kv.rf.GetState()
		if isLeader {
			do()
		}
		time.Sleep(timeout)
	}
}

// leader å‘¨æœŸæ€§ç›‘å¬ shardctrler çš„æœ€æ–°é…ç½®
func (kv *ShardKV) watchConfig() {
	// ä¸º leader å¹¶ä¸” ç°é˜¶æ®µæ²¡æœ‰å¾…åŠåˆ†ç‰‡ä»»åŠ¡
	currentConfigNum, notNormal := kv.hasShardNotNormal()
	if !notNormal {
		// bugæƒ…å†µï¼šQuery ä¸€ç›´é˜»å¡ï¼ŒErrWrongLeader å…¨ false
		// bugfix: lab4A ä¸è¦ä½¿ç”¨ ErrWrongLeader boolï¼Œå› ä¸ºé›¶å€¼æ˜¯ falseï¼Œå¯èƒ½ä¼šå¼•èµ·ä¸å¿…è¦çš„ bug
		nextConfig := kv.sc.Query(currentConfigNum + 1)
		if currentConfigNum+1 == nextConfig.Num {
			// å°†åˆ†ç‰‡çŠ¶æ€æ›´æ”¹ï¼Œä»è€Œ è®©å¦ä¸€ä¸ªç›‘å¬çº¿ç¨‹ï¼Œè§¦å‘åˆ†ç‰‡æ›´æ–°
			// æ‹‰å–æ–°çš„åˆ†ç‰‡ï¼Œå°†æ—§åˆ†ç‰‡åˆ é™¤æ‰ï¼Œéƒ½è¦èµ° raft
			err := kv.startAndApply(nextConfig)
		}
	}
}

// åˆ†ç‰‡è¿ç§»é‡‡ç”¨ push æ¨¡å¼
func (kv *ShardKV) watchShardAndMigrate() {
	shardsNeedPush := kv.shardsWithStatus(shardPushing)
	// æœ‰åˆ†ç‰‡éœ€è¦æ¨é€ç»™å…¶ä»– server
	DPrintf("[watchShardAndMigrate] %v %v", kv.num(), shardsNeedPush)
	var wg sync.WaitGroup
	for gid, shardIds := range shardsNeedPush {
		wg.Add(1)
		go func(innerGid int, innerShardIds []int) {
			defer wg.Done()
      // æ‰§è¡Œåˆ†ç‰‡è¿ç§»
			kv.callMigrateShard(innerGid, innerShardIds)
		}(gid, shardIds)
	}
	wg.Wait()
}
```

### åˆ†ç‰‡è¿ç§»

å…³äºåˆ†ç‰‡è¿ç§»ï¼Œå¯ä»¥æƒ³åˆ°æœ‰ push æˆ– pull æ¨¡å¼ï¼Œåœ¨å’Œå¤§ä½¬çš„è®¨è®ºåï¼Œå†³å®šé‡‡ç”¨ push æ¨¡å¼

> https://github.com/LebronAl/MIT6.824-2021/issues/11

åŸå› å¦‚ä¸‹ï¼š

> è€ƒè™‘ push æ¨¡å¼å’Œ pull æ¨¡å¼çš„ä¸åŒï¼š
> å¦‚æœæ˜¯ push æ¨¡å¼ï¼Œå­˜åœ¨ G1 å’Œ G2ï¼ŒG1 éœ€è¦ push åˆ†ç‰‡æ•°æ®ç»™ G2ï¼Œpush æˆåŠŸåéœ€è¦ GCï¼Œå³ï¼š
>
> G1 ===== push args ======> G2
>
> G2 Start -> apply
>
> G1 <==== push reply ======= G2
>
> ä¸€æ¬¡ rpc å³å¯çŸ¥é“ push æˆåŠŸäº†ï¼Œéšå³ G1 å³å¯è¿›è¡Œ GC
>
> G1 Start GC -> apply
>
>
> å¦‚æœæ˜¯ pull æ¨¡å¼ï¼ŒG1 éœ€è¦ä»G2 pull åˆ†ç‰‡æ•°æ®ï¼Œpull æˆåŠŸåï¼ŒG2 éœ€è¦ GCï¼Œå³ï¼š
>
> G1 ===== pull args ======> G2
>
> G1 <===== pull reply ====== G2
>
> G1 Start -> apply
>
> G2 å¹¶ä¸èƒ½æ˜ç¡® pull reply æ˜¯å¦çœŸæ­£åˆ°è¾¾ï¼Œåªæœ‰ G1 æ‰å¯ä»¥æ˜ç¡®ï¼Œæ‰€ä»¥éœ€è¦ G1 å†å‘é€ GC çš„é€šçŸ¥ï¼ŒG2 æ¥æ”¶åˆ°åæ–¹å¯GC
>
> G1 ===== GC args =====> G2
>
> G2 Start GC -> apply
>
> G1 <===== GC reply ===== G2
>
> åˆæ­¥çŒœæƒ³ï¼Œå„æœ‰åˆ©å¼Šï¼Œpush æ¨¡å¼æ¯” pull æ¨¡å¼å°‘ä¸€æ¬¡ rpc è°ƒç”¨

push æ¨¡å¼æ¯” pull æ¨¡å¼å°‘ä¸€æ¬¡ rpc è°ƒç”¨ï¼Œå¹¶ä¸” pull æ¨¡å¼éœ€è¦ä¿ç•™ä¸Šä¸€æ¬¡çš„ Config ä¿¡æ¯ï¼Œpush æ¨¡å¼ä¸éœ€è¦

åˆ™åŸºäº push æ¨¡å¼çš„å…³äºåˆ†ç‰‡çš„çŠ¶æ€è½¬ç§»å›¾ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![image-20211221142900470](./img/image-20211221142900470.png)

åˆ†ç‰‡è¿ç§»ï¼Œæ¸…ç†ä¸­ï¼ŒåŸå®ç°æ˜¯é€ä¸ª shard åšæ“ä½œï¼Œå…¶å®åº”è¯¥æ˜¯é€ä¸ª gid åšæ“ä½œï¼Œå°†åŒä¸€ä¸ª gid çš„ä¸åŒ shard èšåˆæˆ `map[int][]int`ï¼Œç„¶åç»Ÿä¸€ä¸€ç»„ shards åšæ“ä½œï¼Œç»Ÿä¸€è¿ç§»ï¼Œç»Ÿä¸€æ¸…ç†ï¼Œå¢åŠ ååé‡

ä¸€æ¬¡æ­£å¸¸çš„æ›´æ–°é…ç½®ï¼Œç„¶ååˆ†ç‰‡è¿ç§»å’ŒGCçš„å®Œæ•´æµç¨‹åº”è¯¥æ˜¯ï¼š

1. group å‘ç°æ‰€æœ‰åˆ†ç‰‡çŠ¶æ€æ­£å¸¸ï¼Œæ‹‰å–æ–°é…ç½®
2. ä½¿ç”¨ raft æ‰§è¡Œé…ç½®æ›´æ–°ï¼Œå‘ç°æœ‰åˆ†ç‰‡éœ€è¦ push æˆ–è€…æœ‰åˆ†ç‰‡éœ€è¦ç­‰å¾…åˆ«äººpush ç»™æˆ‘
3. å°†éœ€è¦ push çš„åˆ†ç‰‡ push ç»™å…¶ä»– group
4. å…¶ä»– group å®‰è£…åˆ†ç‰‡ï¼Œå¹¶æˆåŠŸè¿”å›
5. push æˆåŠŸï¼Œå¯ä»¥ç«‹å³ä½¿ç”¨ raft å¼€å§‹ GC åˆ†ç‰‡
6. GC å®Œæ¯•ï¼Œè‡³æ­¤æ‰€æœ‰åˆ†ç‰‡é‡å› normal

ä½¿ç”¨ push æ¨¡å¼çš„è¯ï¼Œåˆ™ server ä¹‹é—´çš„ rpc äº¤äº’é€»è¾‘å¯ä»¥å†™å‡ºï¼š

```go
type ShardReceiveArgs struct {
	ConfigNum              int
	ShardIds               []int                     // ä¸€æ¬¡æ€§å‘ gid æ¨é€éœ€è¦æ‹‰å–çš„æ‰€æœ‰shards
	Datas                  map[int]map[string]string // å¾…æ¨é€çš„æ‰€æœ‰ shard æ•°æ®
	ClientId2RequestIdMaps map[int]map[int64]int64   // å¾…æ¨é€çš„æ‰€æœ‰é‡å¤æ£€æµ‹æ•°æ®
}

type ShardReceiveReply struct {
	Err Err
}

// MigrateShard Push æ¨¡å¼
// MigrateShard server ä¹‹é—´çš„é€šè®¯ï¼Œpush æ¨¡å‹ï¼Œæ•…éœ€è¦é˜²æ­¢é‡å¤çš„ push
func (kv *ShardKV) MigrateShard(args *ShardReceiveArgs, reply *ShardReceiveReply) {

	// 1. åˆæ³•åˆ¤æ–­ï¼Œåˆ¤æ–­æ˜¯å¦ä¸º leaderï¼Œåˆ¤æ–­ configNum
  doSomething()

  // 2. å®‰è£…åˆ†ç‰‡ï¼Œæ‰§è¡Œ shardOp
	// æˆ‘è¿™è¾¹ä¸º pullingï¼Œè°ƒç”¨æ–¹ä¸º pushing
	shardOp := ShardOp{
		Type:          shardInstallOp,
		ConfigNum:     argsConfigNum,
		ShardIds:      shardIds,
		Datas:         args.Datas,
		RequestIdMaps: args.ClientId2RequestIdMaps,
	}
	reply.Err = kv.startAndApply(shardOp)
}
```

## å¼•å…¥çš„ bug

1. æ•°æ®ç«æ€ï¼šlabrpc æ¡†æ¶ä¸‹ï¼Œrpc çš„ args å’Œ reply æ•°æ®éƒ½éœ€è¦æ·±æ‹·è´ï¼›åŸæ¥çš„å®ç°é‡Œæ¥æ”¶ reply çš„æ•°æ®æ˜¯ç›´æ¥èµ‹å€¼åˆ° shardï¼Œå¯¼è‡´æ•°æ®ç«æ€ï¼Œåœ¨ labrpc æ¡†æ¶ä¸­ï¼Œè¿™æ ·åšä¼šå¯¼è‡´æ•°æ®ç«æ€
2. æ´»é”ï¼šlab4A å¼•å…¥çš„ bugï¼Œåœ¨æ£€æµ‹åˆ°é‡å¤è¯·æ±‚åï¼Œæ²¡æœ‰ close doneChanï¼Œå¯¼è‡´ä¸€æ¬¡ ErrTimeout ä¹‹åæ¯æ¬¡éƒ½ ErrTimeoutäº†ï¼Œæ‰€ä»¥ï¼ŒdoneChan æ— è®ºå¦‚ä½•éƒ½è¦é‡Šæ”¾æ‰
3. expected 5 completions with one shard dead; got (3/4)ï¼šè¿™ä¸ªé—®é¢˜æˆ‘æ˜¯å°† serverTimeout ä» 2s å‡å°‘åˆ°äº† 500msï¼Œå› ä¸ºçœ‹åˆ°æµ‹è¯•ä»£ç ä¸­çš„è¶…æ—¶è®¡æ—¶å°±æ˜¯ 2s

## ç–‘é—®

#### multi-group ä¹‹é—´çš„æœ¨æ¡¶æ•ˆåº”

åœ¨ monitor ä¸­ï¼Œæ£€æµ‹åˆ°æœ‰ä¸ä¸º normal çŠ¶æ€çš„ shard åˆ™ä¸ä¼šæ‹‰å–æœ€æ–°é…ç½®åšé…ç½®æ›´æ–°ï¼Œåˆ™å¿…å®šä¼šæœ‰ group çš„åˆ†ç‰‡è¿ç§»æˆ–GC ä»»åŠ¡å¹¶æœªå®Œæˆï¼Œå…¶ä»– group å³ä½¿å‡çº§åˆ°æ›´é«˜çš„ configï¼Œä¹Ÿå¯èƒ½éœ€è¦ç­‰å¾… configNum ä½çš„ group å®Œæˆåˆ†ç‰‡ä»»åŠ¡ï¼Œæ•´ä¸ªç³»ç»Ÿæ‰ä¼šæ»šåŠ¨å‘å‰å¹¶æ•´ä½“å¯ç”¨ï¼›

ä½†æ— è®ºåˆ†ç‰‡è¿ç§»ä½¿ç”¨çš„æ˜¯ push è¿˜æ˜¯ pullï¼Œåœ¨è¿™é‡Œæˆ‘æœ‰ä¸€ç‚¹è‡ªå·±çš„ç–‘é—®ï¼Œä¸çŸ¥é“è¿™æ ·è€ƒè™‘æ˜¯å¦æ­£ç¡®

>configNum: []int (index: shardId, value: gid)
>
>1: [100, 100, 100]
>
>2: [100, 101, 102]
>
>3: [100, 100, 100]
>
>4: [100, 101, 102]
>
>å½“ gid ä¸º 101 çš„ group ç›´æ¥ shutdown äº†ï¼Œç„¶åä» configNum 0 å¼€å§‹é‡æ”¾ï¼ˆå¦‚æœæ²¡æœ‰ persister åšå¿«ç…§ï¼‰
>
>å¦‚æœæ˜¯ pull æ¨¡å¼ï¼Œ101 åœ¨ conigNum 2 ä¼š pull 100 çš„1å·åˆ†ç‰‡ï¼Œåœ¨ configNum 3 æ—¶ï¼Œ101çš„ 1 å·åˆ†ç‰‡åˆä¸€ç›´ä¸º BePullingï¼Œç­‰å¾… 100 çš„ pull ï¼Œä½†æ˜¯ 100 åœ¨ configNum 4ï¼Œ ç„¶å 101 å°±ä¸€ç›´å¡åœ¨ configNum 3 äº†
>
>å¦‚æœæ˜¯ push æ¨¡å¼ï¼Œåœ¨ configNum 2 æ—¶ï¼Œ101 çš„ 1 å·åˆ†ç‰‡ä¸º BePushingï¼Œä¸€ç›´ç­‰å¾… 100 çš„ pushï¼Œä½†æ˜¯ 100 å’Œ 102 éƒ½åœ¨ configNum 4 äº†
>è¿™ä¸ªé‡æ”¾çš„é—®é¢˜æ˜¯å¦ä¼šå‘ç”Ÿï¼Ÿ

æˆ‘ä½¿ç”¨ push æ¨¡å¼ï¼Œæµ‹è¯•éƒ½å¯ä»¥é€šè¿‡ï¼Œå¦‚ä¸Šé¡¾è™‘çš„ç–‘é—®å¹¶æ²¡æœ‰å‘ç”Ÿ

## å®éªŒç»“æœ

![image-20211221150121396](./img/image-20211221150121396.png)

æœ‰ç‚¹å°æ…¢ï¼Œçœ‹labéƒ½æ˜¯ 100s åˆšå‡ºå¤´ï¼Œåç»­æƒ³èµ·æ¥äº†å†é‡æ„ä¸€ä¸‹

## æ„Ÿæƒ³

å®Œç»“æ’’èŠ±ğŸ‰

lab4B çš„éš¾åº¦åº”è¯¥æ˜¯æ•´ä¸ª lab ç³»åˆ—æœ€å¤§çš„ï¼Œä½†æ˜¯æˆ‘åœ¨è®¾è®¡æ–¹æ¡ˆä¸Šå‚è€ƒäº†åˆ«äººçš„å®ç°ï¼Œæ¯”èµ· lab2ï¼Œå¯ä»¥æœ‰ä¸€ä»½è®ºæ–‡åšä¸ºå‚è€ƒï¼Œlab4B åŸºæœ¬æ²¡æœ‰å¯ä»¥å‚è€ƒçš„ç»†èŠ‚ï¼›MIT6.824 çœŸçš„æ˜¯ç¥è¯¾ï¼Œä¸€å¥— lab paper schedule è·Ÿä¸‹æ¥ï¼Œç”šè‡³å¯ä»¥å†™åˆ°ç®€å†ä¸Šï¼Œä»€ä¹ˆæ—¶å€™å›½å†…çš„é«˜æ ¡æ•™è‚²å¯ä»¥æœ‰è¿™æ ·çš„è¯¾ç¨‹å®‰æ’å‘¢ï¼Ÿæ„Ÿè§‰é¥é¥æ— æœŸ

åç»­è¿˜è¦ç»§ç»­è¯» paperï¼Œä¸Šé¢æœ‰ä¸€äº›å¯¹ paper çš„é—®é¢˜è¿˜æ˜¯å€¼å¾—å›ç­”çš„

